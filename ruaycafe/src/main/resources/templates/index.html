<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏ß‡∏¢‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà POS</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
    <div class="menu-section">
        <div class="menu-header">
            <h1>‚òï ‡∏£‡∏ß‡∏¢‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà</h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="color: #999; font-size: 14px;">
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span th:text="${#dates.format(#dates.createNow(), 'dd/MM/yyyy')}"></span>
                </div>
                <button class="btn-edit-menu" onclick="toggleEditMode()">
                    <span>‚úèÔ∏è</span>
                    <span id="editModeText">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π</span>
                </button>
            </div>
        </div>

        <div class="menu-grid" id="menuGrid">
            <div class="menu-item" th:each="p : ${products}"
                 th:attr="data-id=${p.id}, data-name=${p.name}, data-price=${p.price}">
                <div class="edit-badge">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                <img th:src="@{${p.image}}" th:alt="${p.name}">
                <div class="menu-item-info">
                    <div class="menu-item-name" th:text="${p.name}">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    <div class="menu-item-price" th:text="'‡∏ø' + ${p.price}">‡∏ø0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="order-section">
        <div class="order-header">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>
            <div class="order-number">Order #001</div>
        </div>

        <div class="order-items" id="orderItems">
            <div class="empty-cart" th:if="${cart.size() == 0}">
                <div class="empty-cart-icon">üõí</div>
                <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
            </div>

            <div th:if="${cart.size() > 0}">
                <div class="order-item" th:each="c : ${cart}">
                    <div class="order-item-info">
                        <div class="order-item-name" th:text="${c.name}">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                        <div class="order-item-price" th:text="'‡∏ø' + ${c.price} + ' x ' + ${c.qty}">‡∏ø0 x 1</div>
                    </div>
                    <div class="quantity-controls">
                        <span class="quantity" th:text="${c.qty}">1</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="order-summary">
            <div class="summary-row">
                <span>‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (<span th:text="${cart.size()}">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                <span th:text="'‡∏ø' + ${#numbers.formatDecimal(sum, 1, 2)}">‡∏ø0</span>
            </div>
            <div class="summary-row">
                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span>
                <span>‡∏ø0</span>
            </div>
            <div class="summary-row total">
                <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                <span th:text="'‡∏ø' + ${#numbers.formatDecimal(sum, 1, 2)}">‡∏ø0</span>
            </div>
            <div class="action-buttons">
                <form method="post" th:action="@{/cart/clear}" style="display: contents;">
                    <button type="submit" class="btn btn-clear">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </form>
                <button class="btn btn-checkout" onclick="checkout()">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing product -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π</div>
        <form id="editForm">
            <input type="hidden" id="editProductId">
            <div class="form-group">
                <label for="editName">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                <input type="text" id="editName" required>
            </div>
            <div class="form-group">
                <label for="editPrice">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
                <input type="number" id="editPrice" step="0.01" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-modal btn-cancel" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="btn-modal btn-save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    let editMode = false;

    function toggleEditMode() {
        editMode = !editMode;
        const btn = document.querySelector('.btn-edit-menu');
        const btnText = document.getElementById('editModeText');
        const menuGrid = document.getElementById('menuGrid');

        if (editMode) {
            btn.style.background = 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)';
            btnText.textContent = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            menuGrid.classList.add('edit-mode');

            // Change click handlers
            document.querySelectorAll('.menu-item').forEach(item => {
                item.onclick = function() {
                    openEditModal(this);
                };
            });
        } else {
            btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            btnText.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π';
            menuGrid.classList.remove('edit-mode');

            // Restore original click handlers
            document.querySelectorAll('.menu-item').forEach(item => {
                item.onclick = function() {
                    addToCart(this.getAttribute('data-id'));
                };
            });
        }
    }

    function openEditModal(itemElement) {
        const id = itemElement.getAttribute('data-id');
        const name = itemElement.getAttribute('data-name');
        const price = itemElement.getAttribute('data-price');

        document.getElementById('editProductId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editPrice').value = price;
        document.getElementById('editModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const id = document.getElementById('editProductId').value;
        const name = document.getElementById('editName').value;
        const price = document.getElementById('editPrice').value;

        try {
            const response = await fetch('/api/products/' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, price })
            });

            if (response.ok) {
                alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                closeModal();
                location.reload();
            } else {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏ô‡∏π');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
            closeModal();
        }
    };

    // Add to cart function
    async function addToCart(productId) {
        if (editMode) return;

        const res = await fetch('/cart/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({productId: productId})
        });
        const data = await res.json();
        if(data.ok){
            location.reload();
        } else {
            alert(data.msg || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    }

    // Checkout function
    async function checkout() {
        const res = await fetch('/checkout', {method: 'POST'});
        const data = await res.json();
        if(data.ok){
            alert('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø' + data.total);
            location.reload();
        } else {
            alert(data.msg || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ');
        }
    }

    // Initialize click handlers on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.menu-item').forEach(item => {
            item.onclick = function() {
                addToCart(this.getAttribute('data-id'));
            };
        });
    });
</script>
</body>
</html>